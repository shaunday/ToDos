<UserControl x:Class="Todos.Ui.Sections.Tasks.AddTaskControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:sys="clr-namespace:System;assembly=mscorlib"
             xmlns:DotNetCommon="clr-namespace:ToDos.DotNet.Common;assembly=Todos.DotNet.Common"
             xmlns:local="clr-namespace:Todos.Ui.Resources.Converters"
             mc:Ignorable="d"
             d:DesignWidth="600">

    <UserControl.Resources>
        <ResourceDictionary>
            <!-- Enum values for Priority -->
            <ObjectDataProvider x:Key="TaskPriorityValues"
                                MethodName="GetValues"
                                ObjectType="{x:Type sys:Enum}">
                <ObjectDataProvider.MethodParameters>
                    <x:Type TypeName="DotNetCommon:TaskPriority"/>
                </ObjectDataProvider.MethodParameters>
            </ObjectDataProvider>
        </ResourceDictionary>
    </UserControl.Resources>

    <StackPanel>
        <!-- Always-visible Add Task button -->
        <Button Command="{Binding ShowAddTaskFormCommand}"
                Style="{DynamicResource MaterialDesignRaisedButton}"
                Margin="0,0,0,16"
                HorizontalAlignment="Right"
                Visibility="{Binding IsAddingNewTask, Converter={StaticResource InverseBooleanToVisibilityConverter}}">
            <StackPanel Orientation="Horizontal">
                <materialDesign:PackIcon Kind="Plus" Margin="0,0,6,0"/>
                <TextBlock Text="Add Task"/>
            </StackPanel>
        </Button>

        <!-- Inline Add Task Form -->
        <Border Padding="16,12" 
                Background="#F5F5F5"
                BorderBrush="{DynamicResource MaterialDesignDivider}"
                BorderThickness="0,1,0,1"
                Margin="0,0,0,16"
                Visibility="{Binding IsAddingNewTask, Converter={StaticResource BooleanToVisibilityConverter}}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Form Title -->
                <TextBlock Grid.Row="0" Grid.Column="0"
                           Text="Add New Task"
                           Style="{DynamicResource MaterialDesignSubtitle1TextBlock}"
                           Foreground="{DynamicResource MaterialDesignBody}"
                           Margin="0,0,0,12"/>

                <!-- Form Fields -->
                <Grid Grid.Row="1" Grid.Column="0" Margin="0,0,16,0">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="2*"/>
                        <ColumnDefinition Width="2*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <!-- Title Field -->
                    <TextBox Grid.Row="0" Grid.Column="0"
                             Text="{Binding NewTaskBuffer.Title, UpdateSourceTrigger=PropertyChanged}"
                             materialDesign:HintAssist.Hint="Task Title"
                             Margin="0,0,8,12"
                             FontSize="12"
                             Style="{DynamicResource MaterialDesignOutlinedTextBox}"/>

                    <!-- Description Field -->
                    <TextBox Grid.Row="0" Grid.Column="1"
                             Text="{Binding NewTaskBuffer.Description, UpdateSourceTrigger=PropertyChanged}"
                             materialDesign:HintAssist.Hint="Description"
                             Margin="8,0,8,12"
                             FontSize="12"
                             Style="{DynamicResource MaterialDesignOutlinedTextBox}"/>

                    <!-- Priority Field -->
                    <ComboBox Grid.Row="0" Grid.Column="2"
                              SelectedItem="{Binding NewTaskBuffer.Priority}"
                              ItemsSource="{Binding Source={StaticResource TaskPriorityValues}}"
                              materialDesign:HintAssist.Hint="Priority"
                              Margin="0,0,8,12"
                              FontSize="12"
                              Style="{DynamicResource MaterialDesignOutlinedComboBox}"/>

                    <!-- Due Date Field -->
                    <DatePicker Grid.Row="0" Grid.Column="3"
                                SelectedDate="{Binding NewTaskBuffer.DueDate}"
                                materialDesign:HintAssist.Hint="Due Date"
                                Margin="0,0,0,12"
                                FontSize="12"
                                Style="{DynamicResource MaterialDesignOutlinedDatePicker}"/>

                    <!-- Tags Field -->
                    <TextBox Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="4"
                             Text="{Binding NewTaskBuffer.Tags, UpdateSourceTrigger=PropertyChanged}"
                             materialDesign:HintAssist.Hint="Tags (comma or space separated)"
                             Margin="0,0,0,0"
                             FontSize="12"
                             Style="{DynamicResource MaterialDesignOutlinedTextBox}"/>
                </Grid>

                <!-- Error Message -->
                <TextBlock Grid.Row="2" Grid.Column="0"
                           Text="{Binding AddTaskErrorMessage}"
                           Foreground="Red"
                           FontSize="11"
                           Visibility="{Binding AddTaskErrorMessage, Converter={StaticResource StringToVisibilityConverter}}"
                           Margin="0,8,0,0"/>

                <!-- Action Buttons -->
                <StackPanel Grid.Row="1" Grid.Column="1" 
                            Grid.RowSpan="2"
                            Orientation="Horizontal" 
                            VerticalAlignment="Bottom"
                            Margin="16,0,0,0">

                    <Button Command="{Binding AddTaskCommand}"
                            Style="{DynamicResource MaterialDesignRaisedButton}"
                            Margin="0,0,8,0"
                            Padding="12,8"
                            FontSize="12"
                            IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBooleanConverter}}">
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="Check" Width="16" Height="16" Margin="0,0,6,0"/>
                            <TextBlock Text="Save"/>
                        </StackPanel>
                    </Button>

                    <Button Command="{Binding CancelAddTaskCommand}"
                            Style="{DynamicResource MaterialDesignOutlinedButton}"
                            Padding="12,8"
                            FontSize="12"
                            IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBooleanConverter}}">
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="Close" Width="16" Height="16" Margin="0,0,6,0"/>
                            <TextBlock Text="Cancel"/>
                        </StackPanel>
                    </Button>
                </StackPanel>

                <!-- Loading Overlay -->
                <Grid Grid.Row="0" Grid.Column="0" Grid.RowSpan="3"
                      Background="#80000000"
                      Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <ProgressBar Style="{DynamicResource MaterialDesignCircularProgressBar}"
                                 Value="0"
                                 IsIndeterminate="True"
                                 HorizontalAlignment="Center"
                                 VerticalAlignment="Center"/>
                </Grid>
            </Grid>
        </Border>
    </StackPanel>
</UserControl> 